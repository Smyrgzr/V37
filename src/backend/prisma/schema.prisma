// Letwash Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

enum UserRole {
  ROOT_OWNER
  CARWASH_OWNER
  MANAGER
  STAFF
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  fullName      String    @map("full_name")
  phone         String?
  role          UserRole  @default(CARWASH_OWNER)
  isActive      Boolean   @default(true) @map("is_active")
  lastLogin     DateTime? @map("last_login")
  
  // SSO Fields
  googleId      String?   @unique @map("google_id")
  appleId       String?   @unique @map("apple_id")
  microsoftId   String?   @unique @map("microsoft_id")
  cognitoSub    String?   @unique @map("cognito_sub")
  profilePhoto  String?   @map("profile_photo")
  
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  ownedBranches Branch[]  @relation("BranchOwner")
  refreshTokens RefreshToken[]
  notifications Notification[]
  activityLogs  ActivityLog[]
  subscriptions Subscription[]
  businessModules BusinessModule[]
  signedAgreements UserAgreement[]
  transactions Transaction[]
  commissionsReceived Commission[] @relation("OwnerCommissions")
  payoutBatches PayoutBatch[] @relation("OwnerPayouts")

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ============================================
// BRANCH MANAGEMENT
// ============================================

enum BusinessModel {
  IN_BAY
  TUNNEL
  SELF_SERVICE
  MOBILE
  MANUAL_DETAILING
  MOBILE_DETAILING
  PICKUP_DROPOFF_DETAILING
}

model Branch {
  id              String          @id @default(uuid())
  ownerId         String          @map("owner_id")
  name            String
  address         String
  city            String
  state           String?
  zipCode         String?         @map("zip_code")
  country         String          @default("Turkey")
  phone           String
  email           String?
  latitude        Float?
  longitude       Float?
  businessModels  BusinessModel[]
  operatingHours  Json?           @map("operating_hours") // {monday: {open: "08:00", close: "20:00"}, ...}
  isActive        Boolean         @default(true) @map("is_active")
  settings        Json?           // Custom branch settings
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  owner       User         @relation("BranchOwner", fields: [ownerId], references: [id])
  stations    Station[]
  services    Service[]
  bookings    Booking[]
  campaigns   Campaign[]
  customers   Customer[]
  analytics   Analytics[]

  @@index([ownerId])
  @@map("branches")
}

// ============================================
// STATION MANAGEMENT
// ============================================

enum StationStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  OUT_OF_SERVICE
}

enum StationType {
  IN_BAY
  TUNNEL
  SELF_SERVICE
}

model Station {
  id          String        @id @default(uuid())
  branchId    String        @map("branch_id")
  name        String
  type        StationType
  status      StationStatus @default(AVAILABLE)
  capacity    Int           @default(1)
  isActive    Boolean       @default(true) @map("is_active")
  lastService DateTime?     @map("last_service")
  notes       String?
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  branch   Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([branchId, status])
  @@map("stations")
}

// ============================================
// SERVICE MANAGEMENT
// ============================================

enum VehicleType {
  SEDAN
  SUV
  TRUCK
  ELECTRIC_VEHICLE
  LUXURY
  MOTORCYCLE
  VAN
}

model Service {
  id                      String        @id @default(uuid())
  branchId                String        @map("branch_id")
  name                    String
  description             String?
  businessModel           BusinessModel
  basePrice               Decimal       @db.Decimal(10, 2)
  baseDuration            Int           @map("base_duration") // minutes
  vehicleTypeMultipliers  Json          @map("vehicle_type_multipliers") // {SEDAN: 1.0, SUV: 1.3, ...}
  isActive                Boolean       @default(true) @map("is_active")
  displayOrder            Int?          @map("display_order")
  imageUrl                String?       @map("image_url")
  features                String[]      // ["Interior Cleaning", "Wax", ...]
  createdAt               DateTime      @default(now()) @map("created_at")
  updatedAt               DateTime      @updatedAt @map("updated_at")

  // Relations
  branch   Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([branchId, isActive])
  @@map("services")
}

// ============================================
// BOOKING MANAGEMENT
// ============================================

enum BookingStatus {
  REQUESTED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

model Booking {
  id                String          @id @default(uuid())
  branchId          String          @map("branch_id")
  stationId         String?         @map("station_id")
  serviceId         String          @map("service_id")
  customerId        String?         @map("customer_id")
  reservationCode   String          @unique @map("reservation_code")
  
  // Customer Info (for walk-ins without account)
  customerName      String          @map("customer_name")
  customerPhone     String          @map("customer_phone")
  customerEmail     String?         @map("customer_email")
  
  // Vehicle Info
  vehicleType       VehicleType     @map("vehicle_type")
  vehiclePlate      String?         @map("vehicle_plate")
  vehicleBrand      String?         @map("vehicle_brand")
  vehicleModel      String?         @map("vehicle_model")
  vehicleColor      String?         @map("vehicle_color")
  
  // Booking Details
  scheduledDate     DateTime        @map("scheduled_date")
  startTime         DateTime        @map("start_time")
  endTime           DateTime        @map("end_time")
  duration          Int             // minutes
  price             Decimal         @db.Decimal(10, 2)
  discount          Decimal?        @default(0) @db.Decimal(10, 2)
  finalPrice        Decimal         @map("final_price") @db.Decimal(10, 2)
  
  // Status
  status            BookingStatus   @default(REQUESTED)
  paymentStatus     PaymentStatus   @default(PENDING) @map("payment_status")
  
  // Additional Info
  notes             String?
  internalNotes     String?         @map("internal_notes")
  campaignId        String?         @map("campaign_id")
  checkInTime       DateTime?       @map("check_in_time")
  checkOutTime      DateTime?       @map("check_out_time")
  rating            Int?            // 1-5
  review            String?
  
  // Timestamps
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  cancelledAt       DateTime?       @map("cancelled_at")

  // Relations
  branch    Branch    @relation(fields: [branchId], references: [id])
  station   Station?  @relation(fields: [stationId], references: [id])
  service   Service   @relation(fields: [serviceId], references: [id])
  customer  Customer? @relation(fields: [customerId], references: [id])
  campaign  Campaign? @relation(fields: [campaignId], references: [id])

  @@index([branchId, scheduledDate, status])
  @@index([stationId, startTime, endTime])
  @@index([customerId])
  @@index([reservationCode])
  @@map("bookings")
}

// ============================================
// CUSTOMER MANAGEMENT
// ============================================

model Customer {
  id            String    @id @default(uuid())
  branchId      String    @map("branch_id")
  email         String?
  phone         String
  fullName      String    @map("full_name")
  address       String?
  notes         String?
  totalVisits   Int       @default(0) @map("total_visits")
  totalSpent    Decimal   @default(0) @db.Decimal(10, 2) @map("total_spent")
  averageRating Float?    @map("average_rating")
  lastVisit     DateTime? @map("last_visit")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  branch   Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  bookings Booking[]
  vehicles Vehicle[]

  @@index([branchId, phone])
  @@index([branchId, email])
  @@map("customers")
}

model Vehicle {
  id         String      @id @default(uuid())
  customerId String      @map("customer_id")
  type       VehicleType
  plate      String
  brand      String?
  model      String?
  year       Int?
  color      String?
  isDefault  Boolean     @default(false) @map("is_default")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@map("vehicles")
}

// ============================================
// CAMPAIGN MANAGEMENT
// ============================================

enum CampaignType {
  PERCENTAGE_DISCOUNT
  FIXED_AMOUNT_DISCOUNT
  BUY_X_GET_Y
  FREE_SERVICE
  LOYALTY_POINTS
}

model Campaign {
  id                String       @id @default(uuid())
  branchId          String       @map("branch_id")
  title             String
  description       String?
  type              CampaignType
  discountValue     Decimal?     @map("discount_value") @db.Decimal(10, 2)
  discountPercent   Int?         @map("discount_percent")
  minPurchase       Decimal?     @map("min_purchase") @db.Decimal(10, 2)
  maxDiscount       Decimal?     @map("max_discount") @db.Decimal(10, 2)
  startDate         DateTime     @map("start_date")
  endDate           DateTime     @map("end_date")
  isActive          Boolean      @default(true) @map("is_active")
  usageLimit        Int?         @map("usage_limit")
  usageCount        Int          @default(0) @map("usage_count")
  applicableServices String[]    @map("applicable_services") // Service IDs
  applicableVehicles VehicleType[] @map("applicable_vehicles")
  code              String?      @unique
  imageUrl          String?      @map("image_url")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  // Relations
  branch   Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([branchId, isActive, startDate, endDate])
  @@map("campaigns")
}

// ============================================
// ANALYTICS
// ============================================

model Analytics {
  id               String   @id @default(uuid())
  branchId         String   @map("branch_id")
  date             DateTime @db.Date
  totalBookings    Int      @default(0) @map("total_bookings")
  totalRevenue     Decimal  @default(0) @db.Decimal(10, 2) @map("total_revenue")
  totalCustomers   Int      @default(0) @map("total_customers")
  newCustomers     Int      @default(0) @map("new_customers")
  avgBookingValue  Decimal  @default(0) @db.Decimal(10, 2) @map("avg_booking_value")
  avgRating        Float?   @map("avg_rating")
  completionRate   Float?   @map("completion_rate")
  cancellationRate Float?   @map("cancellation_rate")
  peakHours        Json?    @map("peak_hours") // {hour: count}
  topServices      Json?    @map("top_services") // [{serviceId, count, revenue}]
  createdAt        DateTime @default(now()) @map("created_at")

  branch Branch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([branchId, date])
  @@index([branchId, date])
  @@map("analytics")
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  BOOKING_CONFIRMED
  BOOKING_REMINDER
  BOOKING_COMPLETED
  BOOKING_CANCELLED
  PAYMENT_RECEIVED
  CAMPAIGN_ANNOUNCEMENT
  SYSTEM_ALERT
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false) @map("is_read")
  data      Json?            // Additional data
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@map("notifications")
}

// ============================================
// ACTIVITY LOGS
// ============================================

enum ActivityType {
  USER_LOGIN
  USER_LOGOUT
  BOOKING_CREATED
  BOOKING_UPDATED
  BOOKING_CANCELLED
  SERVICE_CREATED
  SERVICE_UPDATED
  CAMPAIGN_CREATED
  STATION_STATUS_CHANGED
  SETTINGS_UPDATED
}

model ActivityLog {
  id          String       @id @default(uuid())
  userId      String       @map("user_id")
  activityType ActivityType @map("activity_type")
  description String
  metadata    Json?        // Additional context
  ipAddress   String?      @map("ip_address")
  userAgent   String?      @map("user_agent")
  createdAt   DateTime     @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@map("activity_logs")
}

// ============================================
// SUBSCRIPTION & BILLING
// ============================================

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  EXPIRED
}

enum SubscriptionTier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

model Subscription {
  id                String             @id @default(uuid())
  userId            String             @map("user_id")
  tierId            SubscriptionTier   @map("tier_id")
  billingCycle      BillingCycle       @map("billing_cycle")
  status            SubscriptionStatus @default(TRIAL)
  trialEndsAt       DateTime?          @map("trial_ends_at")
  currentPeriodStart DateTime          @map("current_period_start")
  currentPeriodEnd   DateTime          @map("current_period_end")
  canceledAt        DateTime?          @map("canceled_at")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessModules BusinessModule[]

  @@index([userId, status])
  @@map("subscriptions")
}

model BusinessModule {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  subscriptionId String   @map("subscription_id")
  moduleName     String   @map("module_name") // in-bay, tunnel, self-service, etc.
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([userId, moduleName])
  @@map("business_modules")
}

// ============================================
// AGREEMENTS & CONTRACTS
// ============================================

enum AgreementType {
  TERMS_OF_SERVICE
  PRIVACY_POLICY
  TRANSACTION_AGREEMENT
  CARWASH_OWNER_AGREEMENT
  SERVICE_LEVEL_AGREEMENT
}

enum AgreementStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

model Agreement {
  id          String          @id @default(uuid())
  type        AgreementType
  version     String          // e.g., "1.0", "2.1"
  title       String
  content     String          @db.Text
  status      AgreementStatus @default(DRAFT)
  effectiveDate DateTime      @map("effective_date")
  expiryDate    DateTime?     @map("expiry_date")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  // Relations
  userSignatures UserAgreement[]

  @@unique([type, version])
  @@index([type, status, effectiveDate])
  @@map("agreements")
}

model UserAgreement {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  agreementId  String   @map("agreement_id")
  signedAt     DateTime @default(now()) @map("signed_at")
  ipAddress    String   @map("ip_address")
  userAgent    String   @map("user_agent")
  signatureData Json?   @map("signature_data") // Digital signature metadata

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agreement Agreement @relation(fields: [agreementId], references: [id])

  @@unique([userId, agreementId])
  @@index([userId])
  @@map("user_agreements")
}

// ============================================
// PAYMENT & TRANSACTIONS
// ============================================

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  CASH
  BANK_TRANSFER
  DIGITAL_WALLET
  APPLE_PAY
  GOOGLE_PAY
}

enum TransactionType {
  BOOKING_PAYMENT
  SUBSCRIPTION_PAYMENT
  REFUND
  COMMISSION_SETTLEMENT
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  DISPUTED
}

model Transaction {
  id                  String            @id @default(uuid())
  bookingId           String?           @map("booking_id")
  subscriptionId      String?           @map("subscription_id")
  userId              String            @map("user_id")
  type                TransactionType
  status              TransactionStatus @default(PENDING)
  
  // Payment Details
  amount              Decimal           @db.Decimal(10, 2)
  currency            String            @default("TRY")
  paymentMethod       PaymentMethod     @map("payment_method")
  
  // Commission Calculation
  grossAmount         Decimal           @map("gross_amount") @db.Decimal(10, 2)
  commissionRate      Decimal           @map("commission_rate") @db.Decimal(5, 2) // percentage
  commissionAmount    Decimal           @map("commission_amount") @db.Decimal(10, 2)
  netAmount           Decimal           @map("net_amount") @db.Decimal(10, 2) // amount to carwash owner
  
  // Payment Gateway Info
  paymentGateway      String?           @map("payment_gateway") // stripe, paypal, iyzico
  gatewayTransactionId String?          @unique @map("gateway_transaction_id")
  gatewayResponse     Json?             @map("gateway_response")
  
  // Additional Info
  description         String?
  metadata            Json?
  failureReason       String?           @map("failure_reason")
  refundedAmount      Decimal?          @default(0) @db.Decimal(10, 2) @map("refunded_amount")
  
  // Timestamps
  processedAt         DateTime?         @map("processed_at")
  settledAt           DateTime?         @map("settled_at")
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id])
  commissions  Commission[]

  @@index([userId, status, createdAt])
  @@index([bookingId])
  @@index([subscriptionId])
  @@index([gatewayTransactionId])
  @@map("transactions")
}

// ============================================
// COMMISSION TRACKING
// ============================================

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
  DISPUTED
}

model Commission {
  id                String           @id @default(uuid())
  transactionId     String           @map("transaction_id")
  carwashOwnerId    String           @map("carwash_owner_id")
  branchId          String?          @map("branch_id")
  
  // Commission Calculation
  transactionAmount Decimal          @map("transaction_amount") @db.Decimal(10, 2)
  commissionRate    Decimal          @map("commission_rate") @db.Decimal(5, 2)
  commissionAmount  Decimal          @map("commission_amount") @db.Decimal(10, 2)
  
  // Status
  status            CommissionStatus @default(PENDING)
  
  // Payout Info
  payoutBatchId     String?          @map("payout_batch_id")
  paidAt            DateTime?        @map("paid_at")
  paymentReference  String?          @map("payment_reference")
  
  // Metadata
  notes             String?
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")

  // Relations
  transaction    Transaction @relation(fields: [transactionId], references: [id])
  carwashOwner   User        @relation("OwnerCommissions", fields: [carwashOwnerId], references: [id])

  @@index([carwashOwnerId, status])
  @@index([transactionId])
  @@index([payoutBatchId])
  @@map("commissions")
}

// ============================================
// PAYOUT BATCHES
// ============================================

enum PayoutStatus {
  SCHEDULED
  PROCESSING
  COMPLETED
  FAILED
}

model PayoutBatch {
  id                String       @id @default(uuid())
  ownerId           String       @map("owner_id")
  totalAmount       Decimal      @map("total_amount") @db.Decimal(10, 2)
  commissionCount   Int          @map("commission_count")
  status            PayoutStatus @default(SCHEDULED)
  
  // Bank Details
  bankAccountName   String?      @map("bank_account_name")
  bankAccountNumber String?      @map("bank_account_number")
  bankName          String?      @map("bank_name")
  
  // Processing Info
  scheduledDate     DateTime     @map("scheduled_date")
  processedAt       DateTime?    @map("processed_at")
  completedAt       DateTime?    @map("completed_at")
  failureReason     String?      @map("failure_reason")
  
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  // Relations
  owner User @relation("OwnerPayouts", fields: [ownerId], references: [id])

  @@index([ownerId, status])
  @@index([scheduledDate])
  @@map("payout_batches")
}